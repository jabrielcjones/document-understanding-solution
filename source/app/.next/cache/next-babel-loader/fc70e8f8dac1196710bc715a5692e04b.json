{"ast":null,"code":"import _regeneratorRuntime from \"/home/jabrielcjones/dev/belle_fleur/document-understanding-solution/source/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/home/jabrielcjones/dev/belle_fleur/document-understanding-solution/source/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _extends from \"/home/jabrielcjones/dev/belle_fleur/document-understanding-solution/source/node_modules/@babel/runtime/helpers/esm/extends\";\nimport _defineProperty from \"/home/jabrielcjones/dev/belle_fleur/document-understanding-solution/source/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n/**********************************************************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *\n *                                                                                                                    *\n *  Licensed under the Apache License, Version 2.0 (the License). You may not use this file except in compliance    *\n *  with the License. A copy of the License is located at                                                             *\n *                                                                                                                    *\n *      http://www.apache.org/licenses/LICENSE-2.0                                                                    *\n *                                                                                                                    *\n *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES *\n *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions    *\n *  and limitations under the License.                                                                                *\n *********************************************************************************************************************/\nimport React, { useCallback, useEffect, useState, Fragment } from 'react';\nimport { connect } from 'react-redux';\nimport classNames from 'classnames';\nimport { Storage } from 'aws-amplify';\nimport { useDropzone } from 'react-dropzone';\nimport { format } from 'date-fns';\nimport uuid from \"uuid/v4\";\nimport getConfig from \"next/config\";\nimport Button from '../Button/Button';\nimport Modal from '../Modal/Modal';\nimport { useContext } from 'react';\nimport ModalContext from '../ModalContext/ModalContext';\nimport CameraCapture from '../CameraCapture/CameraCapture';\nimport { submitDocument } from '../../store/entities/documents/actions';\nimport { clearSearchQuery } from '../../store/entities/meta/actions';\nimport css from './FileUpload.scss';\n\nvar _getConfig = getConfig(),\n    isROMode = _getConfig.publicRuntimeConfig.isROMode;\n\nfunction FileUpload(_ref) {\n  var dispatch = _ref.dispatch;\n\n  var _useState = useState({}),\n      canUseCamera = _useState[0],\n      setCanUseCamera = _useState[1];\n\n  var _useState2 = useState(false),\n      cameraCapturing = _useState2[0],\n      setCameraCapturing = _useState2[1];\n\n  var _useState3 = useState({}),\n      fileStatus = _useState3[0],\n      setFileStatus = _useState3[1];\n\n  var _useState4 = useState(''),\n      uploadStatus = _useState4[0],\n      setUploadStatus = _useState4[1];\n\n  var _useState5 = useState({}),\n      files = _useState5[0],\n      setFiles = _useState5[1];\n\n  var _ref2 = isROMode === \"true\" ? useContext(ModalContext) : useState(''),\n      modal = _ref2.modal,\n      setModal = _ref2.setModal;\n\n  var fileNames = Object.keys(files); // Aggregate upload statuses\n\n  var isUploadPending = uploadStatus === 'pending';\n  var isUploadSuccessful = uploadStatus === 'success';\n  var isUploadFailed = uploadStatus === 'error';\n  var isReadyToUpload = !uploadStatus;\n  useEffect(function () {\n    var md = window.navigator && navigator.mediaDevices;\n\n    if (!md || !md.enumerateDevices) {\n      setCanUseCamera(false);\n    } else {\n      md.enumerateDevices().then(function (devices) {\n        setCanUseCamera(devices.some(function (device) {\n          return device.kind === 'videoinput';\n        }));\n      });\n    }\n  }, []); // Configure dropzone\n\n  var onDrop = useCallback(function (acceptedFiles) {\n    if (isROMode === 'true') {\n      setModal(true);\n    } else {\n      var fileMap = {};\n      setUploadStatus('');\n      acceptedFiles.forEach(function (file) {\n        fileMap[file.name] = file;\n      });\n      setFiles(function (files) {\n        return _objectSpread(_objectSpread({}, files), fileMap);\n      });\n    }\n  }, []);\n\n  var _useDropzone = useDropzone({\n    onDrop: onDrop,\n    disabled: !isReadyToUpload\n  }),\n      getRootProps = _useDropzone.getRootProps,\n      getInputProps = _useDropzone.getInputProps,\n      isDragActive = _useDropzone.isDragActive;\n  /**\n  * Handle clicks on the select documents CTA when the mode is Demonstration Mode\n  *\n  */\n\n\n  var handleSelectDocumentsClickDemoOnly = useCallback(function () {\n    setModal(true);\n  }, []); // Dynamic class names\n\n  var fileUploadClassNames = classNames(css.fileUpload, _defineProperty({}, css.dragActive, isDragActive));\n  /**\n   * Click handler for upload button\n   */\n\n  var handleUploadClick = useCallback(function () {\n    // Set aggregate status\n    setUploadStatus('pending'); // Upload files\n\n    var uploads = uploadFiles({\n      fileNames: fileNames,\n      files: files,\n      onProgress: function onProgress(_ref3) {\n        var fileName = _ref3.fileName,\n            progress = _ref3.progress;\n        setFileStatus(function (fileStatus) {\n          return _objectSpread(_objectSpread({}, fileStatus), _defineProperty({}, fileName, {\n            progress: \"\".concat(Math.min(Math.round(progress.loaded / progress.total * 100), 99), \"%\")\n          }));\n        });\n      },\n      onSuccess: function onSuccess(_ref4) {\n        var result = _ref4.result,\n            fileName = _ref4.fileName;\n        return dispatch(submitDocument({\n          key: \"public/\".concat(result.key)\n        })).then(function () {\n          setFileStatus(function (fileStatus) {\n            return _objectSpread(_objectSpread({}, fileStatus), _defineProperty({}, fileName, {\n              success: true\n            }));\n          });\n        });\n      },\n      onError: function onError(_ref5) {\n        var fileName = _ref5.fileName;\n        setFileStatus(function (fileStatus) {\n          return _objectSpread(_objectSpread({}, fileStatus), _defineProperty({}, fileName, {\n            error: true\n          }));\n        });\n      }\n    }); // Set aggregate status based on result of upload promises\n\n    Promise.all(uploads).then(function () {\n      dispatch(clearSearchQuery());\n      setUploadStatus('success');\n    }).catch(function (error) {\n      setUploadStatus('error');\n    });\n  }, [dispatch, fileNames, files]);\n  /**\n   * Delete a file\n   *\n   * @param {String} fileName The name of the file to delete\n   */\n\n  function deleteFile(fileName) {\n    setFiles(function (_ref6) {\n      var files = _extends({}, _ref6);\n\n      return delete files[fileName] && files;\n    });\n  }\n\n  var startCamera = useCallback(function () {\n    setCameraCapturing(true);\n  }, []);\n  var cameraCaptured = useCallback(function (blob) {\n    setCameraCapturing(false);\n    var datestring = format(new Date(), 'YYYYMMDDHHmmss');\n    var filename = \"cameracapture-\".concat(datestring, \".jpg\");\n    setFiles(function (files) {\n      return _objectSpread(_objectSpread({}, files), {}, _defineProperty({}, filename, blob));\n    });\n  }, []);\n\n  if (isROMode === \"true\") {\n    return __jsx(\"div\", null, __jsx(\"div\", getRootProps({\n      className: fileUploadClassNames,\n      onClick: handleSelectDocumentsClickDemoOnly,\n      tabIndex: -1\n    }), __jsx(\"input\", getInputProps({\n      disabled: true\n    })), __jsx(\"img\", {\n      src: \"/static/images/icon_file-upload.svg\",\n      alt: \"File Upload Icon\"\n    }), isDragActive && __jsx(\"p\", {\n      className: css.instructions\n    }, \"Drop the documents here...\"), !isDragActive && isReadyToUpload && __jsx(React.Fragment, null, __jsx(\"p\", {\n      className: css.instructions\n    }, \"Drag and drop files or \", __jsx(\"em\", {\n      tabIndex: \"0\"\n    }, \"Choose documents\")), isReadyToUpload && __jsx(\"p\", {\n      className: css.limits\n    }, \"Accepts JPG/PNG (max 5MB) and PDF (max 150 MB, max 200 pages)\"), canUseCamera && __jsx(\"p\", {\n      className: css.instructions\n    }, \"or \", __jsx(Button, {\n      onClick: function onClick() {\n        return setModal(true);\n      }\n    }, \"use your camera\")))));\n  } else {\n    return __jsx(\"div\", getRootProps({\n      className: fileUploadClassNames,\n      onClick: handleSelectDocumentsClick,\n      tabIndex: -1\n    }), __jsx(\"input\", getInputProps()), __jsx(\"img\", {\n      src: \"/static/images/icon_file-upload.svg\",\n      alt: \"File Upload Icon\"\n    }), isDragActive && __jsx(\"p\", {\n      className: css.instructions\n    }, \"Drop the documents here...\"), !isDragActive && isReadyToUpload && __jsx(React.Fragment, null, __jsx(\"p\", {\n      className: css.instructions\n    }, \"Drag and drop files or \", __jsx(\"em\", {\n      tabIndex: \"0\"\n    }, \"Choose documents\")), isReadyToUpload && __jsx(\"p\", {\n      className: css.limits\n    }, \"Accepts JPG/PNG (max 5MB) and PDF (max 150 MB, max 200 pages)\"), canUseCamera && __jsx(\"p\", {\n      className: css.instructions\n    }, \"or \", __jsx(Button, {\n      onClick: startCamera\n    }, \"use your camera\"))), isUploadPending && __jsx(\"p\", {\n      className: css.instructions\n    }, \"Uploading...\"), isUploadSuccessful && __jsx(\"p\", {\n      className: css.instructions\n    }, \"Done!\"), isUploadFailed && __jsx(\"p\", {\n      className: css.instructions\n    }, \"Something went wrong, please refresh and try again.\"), !!fileNames.length && __jsx(Fragment, null, __jsx(\"ul\", null, fileNames.map(function (fileName) {\n      var status = fileStatus[fileName] || {};\n      var success = status.success,\n          error = status.error,\n          progress = status.progress;\n      return __jsx(\"li\", {\n        key: fileName\n      }, isReadyToUpload && __jsx(\"img\", {\n        src: \"/static/images/icon_document.svg\",\n        alt: \"Document Icon\"\n      }), !success && !error && progress && __jsx(\"span\", null, progress), success && __jsx(\"img\", {\n        src: \"/static/images/icon_success.svg\",\n        alt: \"Success Icon\"\n      }), error && __jsx(\"img\", {\n        src: \"/static/images/icon_error.svg\",\n        alt: \"Error Icon\"\n      }), fileName, isReadyToUpload && __jsx(\"svg\", {\n        height: \"24\",\n        viewBox: \"0 0 24 24\",\n        width: \"24\",\n        xmlns: \"http://www.w3.org/2000/svg\",\n        onClick: function onClick() {\n          return deleteFile(fileName);\n        }\n      }, __jsx(\"path\", {\n        d: \"m12 10.5857864 5.2928932-5.29289318c.3905243-.39052429 1.0236893-.39052429 1.4142136 0s.3905243 1.02368927 0 1.41421356l-5.2928932 5.29289322 5.2928932 5.2928932c.3905243.3905243.3905243 1.0236893 0 1.4142136s-1.0236893.3905243-1.4142136 0l-5.2928932-5.2928932-5.29289322 5.2928932c-.39052429.3905243-1.02368927.3905243-1.41421356 0s-.39052429-1.0236893 0-1.4142136l5.29289318-5.2928932-5.29289318-5.29289322c-.39052429-.39052429-.39052429-1.02368927 0-1.41421356s1.02368927-.39052429 1.41421356 0z\"\n      })));\n    })), isReadyToUpload && __jsx(Button, {\n      inverted: true,\n      onClick: handleUploadClick\n    }, \"Upload\"), !isReadyToUpload && __jsx(Button, {\n      inverted: true,\n      disabled: !isUploadSuccessful,\n      link: {\n        href: '/documents'\n      }\n    }, \"Continue\")), cameraCapturing && __jsx(CameraCapture, {\n      onCapture: cameraCaptured,\n      onCancel: function onCancel() {\n        return setCameraCapturing(false);\n      }\n    }));\n  }\n}\n\nexport default connect()(FileUpload);\n\nfunction isUUIdPresentInS3(_x) {\n  return _isUUIdPresentInS.apply(this, arguments);\n}\n\nfunction _isUUIdPresentInS() {\n  _isUUIdPresentInS = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(documentUUID) {\n    var s3ListPromise, s3Result;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            s3ListPromise = Storage.list(\"\".concat(documentUUID, \"/\")).then(function (result) {\n              return result;\n            });\n            _context.next = 3;\n            return s3ListPromise;\n\n          case 3:\n            s3Result = _context.sent;\n            return _context.abrupt(\"return\", s3Result.length > 0);\n\n          case 5:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n  return _isUUIdPresentInS.apply(this, arguments);\n}\n\nfunction getUniqueDocumentId() {\n  return _getUniqueDocumentId.apply(this, arguments);\n}\n/**\n * Upload files to S3. NOTE: Amplify does not allow you to upload multiple files\n * in a single call, which is why this function runs a loop to make a call for each file.\n *\n * @param {Object}   config             An object of configs\n * @param {Array}    config.fileNames   An array of file names\n * @param {Object}   config.files       An object of files where the keys are the file names\n * @param {Function} config.onSuccess   A callback that fires on success of a single upload\n * @param {Function} config.onError     A callback that fires on error of a single upload\n * @param {Function} config.onProgress  A callback that fires on progress of a single upload\n */\n\n\nfunction _getUniqueDocumentId() {\n  _getUniqueDocumentId = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n    var documentUUID;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            documentUUID = uuid();\n            _context2.next = 3;\n            return isUUIdPresentInS3(documentUUID);\n\n          case 3:\n            if (!_context2.sent) {\n              _context2.next = 7;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", getUniqueDocumentId());\n\n          case 7:\n            return _context2.abrupt(\"return\", documentUUID);\n\n          case 8:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n  return _getUniqueDocumentId.apply(this, arguments);\n}\n\nfunction uploadFiles(_ref7) {\n  var _ref7$fileNames = _ref7.fileNames,\n      fileNames = _ref7$fileNames === void 0 ? [] : _ref7$fileNames,\n      _ref7$files = _ref7.files,\n      files = _ref7$files === void 0 ? {} : _ref7$files,\n      onSuccess = _ref7.onSuccess,\n      onError = _ref7.onError,\n      onProgress = _ref7.onProgress;\n  var fileLengthExceeded = Boolean(fileNames.length > 100);\n\n  if (fileLengthExceeded) {\n    alert(\" Supported no. of files upload limit : less than 100\");\n  }\n\n  return fileNames.map(function (fileName) {\n    var file = files[fileName];\n\n    if (fileLengthExceeded) {\n      return onError({\n        fileName: fileName\n      });\n    }\n\n    if (![\"application/pdf\", \"image/png\", \"image/jpeg\"].includes(file.type)) {\n      alert(fileName + \" : Supported file formats : JPG,PNG,PDF\");\n      return onError({\n        fileName: fileName\n      });\n    }\n\n    if (file.type == \"application/pdf\" && file.size / 1000000 >= 150) {\n      //Maximum File size supported is 150MB\n      alert(fileName + \" : Supported PDF size : less than 150MB\");\n      return onError({\n        fileName: fileName\n      });\n    }\n\n    if ([\"image/png\", \"image/jpeg\"].includes(file.type) && file.size / 1000000 >= 5) {\n      //Maximum File size supported is 5MB\n      alert(fileName + \" : Supported Image size : less than 5MB\");\n      return onError({\n        fileName: fileName\n      });\n    }\n\n    onProgress({\n      progress: {\n        loaded: 0,\n        total: file.size || 100\n      },\n      fileName: fileName,\n      file: file\n    });\n    getUniqueDocumentId().then(function (result) {\n      var key = [result, fileName].join('/');\n      Storage.put(key, file, {\n        progressCallback: function progressCallback(progress) {\n          onProgress({\n            progress: progress,\n            fileName: fileName,\n            file: file\n          });\n        }\n      }).then(function (result) {\n        return onSuccess({\n          result: result,\n          fileName: fileName,\n          file: file\n        });\n      }).catch(function (error) {\n        onError({\n          error: error,\n          fileName: fileName,\n          file: file\n        });\n        throw error;\n      });\n    });\n  });\n}\n/**\n * Handle clicks on the select documents CTA\n *\n * @param {Object} e Event object\n */\n\n\nfunction handleSelectDocumentsClick(e) {\n  e.preventDefault();\n  e.target.tagName.toLowerCase() !== 'em' && e.stopPropagation();\n}","map":null,"metadata":{},"sourceType":"module"}